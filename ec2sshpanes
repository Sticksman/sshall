#!/usr/bin/python

import glob
import os
import platform
import subprocess
import sys
import yaml

#############################################
# This currently works with ASG names only. #
#############################################

defaultYaml = r'''
windows:
  - name: multi ssh
    root: .
    layout: tiled
    panes:
'''

DESCRIBE_EC2_CMD = '''aws ec2 describe-instances --filter Name="instance-state-name",Values="running" "Name=tag:aws:autoscaling:groupName,Values=*%s*" --query  'Reservations[].Instances[].[PrivateIpAddress]' --output text'''

def getTargets(asgFilter):
    cmd = DESCRIBE_EC2_CMD % asgFilter
    targetCall = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE)
    targets = targetCall.stdout.readlines()
    # Filter the target list, remove empty lines and dangling new lines
    return list(filter(lambda t: len(t) >0 and t is not '\n', targets))

def sshLinux(targets):
    if targets:
        for t in targets:
            if system == 'Linux':
                linux_commands += 'bash -c "%s" || bash' % ssh_command 
        subprocess.check_output('terminator-split/terminator-split -e %s localhost' % linux_commands)
    else:
        print('No matching targets founds for query:\n\t%s' % (DESCRIBE_EC2_CMD % asgFilter))
        sys.exit(3)

def sshDarwin(targets, asgFilter):
    if targets:
        try:
            termConf = yaml.load(defaultYaml)
            panes = termConf['windows'][0]['panes'] = []
            
            for t in targets:
                sshCommand = 'ssh ' + t.strip('\n')
                panes.append(sshCommand)
            
            destFilePath = os.path.expanduser('~/.itermocil/%s.yml' % asgFilter)
            if not os.path.exists(os.path.dirname(destFilePath)):
                try:
                    os.makedirs(os.path.dirname(destFilePath))
                except OSError as exc: # Guard against race condition
                    if exc.errno != errno.EEXIST:
                        raise
            destFile = open(destFilePath, 'w+')
            yaml.dump(termConf, destFile, default_flow_style=True, indent=2)
            destFile.close()

            subprocess.Popen('itermocil %s &> /dev/null' % asgFilter, shell=True, stdout=subprocess.PIPE)
        except yaml.YAMLError as exc:
            print('Failed to run: ')
            print(exc)
            sys.exit(2)
    else:
        print('No matching targets founds for query:\n\t%s' % (DESCRIBE_EC2_CMD % asgFilter))
        sys.exit(3)

if len(sys.argv) is not 2:
    print('Usage: sshall <autoscaling group name>\n\tPartial name matches are supported')
    sys.exit(1)

system = platform.system()
asgFilter = sys.argv[1]
if system == 'Darwin':
    # Check that itermocil is installed
    if not any(os.access(os.path.join(path, 'itermocil'), os.X_OK) for path in os.environ['PATH'].split(os.pathsep)):
        print('itermocil not found in system path. Installing itermocil first')
        brewInstall = subprocess.Popen('brew update && brew install TomAnthony/brews/itermocil', shell=True, subprocess.PIPE)
        brewInstall.poll()
        if brewInstall.returncode is not 0:
            print('Failed to install itermocil, please install it manually')
            sys.exit(1)

    sshDarwin(getTargets(asgFilter), asgFilter)
elif system == 'Linux':
    # Check that terminator is installed
    if not any(os.access(os.path.join(path, 'terminator'), os.X_OK) for path in os.environ['PATH'].split(os.pathsep)):
        print('terminator not found in system path. Install terminator first')
        sys.exit(1)

    sshLinux(getTargets(asgFilter))
else:
    print('Only Linux and Darwin (MacOS) systems are supported!')
